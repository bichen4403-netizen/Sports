<!-- å…±åŒæˆå°±ç©ºé—´ï¼šæˆé•¿åœ°å›¾ï¼Œèœ¿èœ’å‘ä¸Šçš„ç™»å±±è·¯å¾„ -->
<view class="shared-container">
  <!-- é¡¶éƒ¨ï¼šä¼™ä¼´å + å…±åŒæˆå°±å€¼ï¼›å³ä¾§ä¸¤äººå¤´åƒï¼ˆä»ä¸Šä¸€é¡µè·å–ï¼ŒåæœŸæ”¹ä¸ºç”¨æˆ·è‡ªå®šä¹‰ï¼‰ -->
  <view class="shared-header">
    <view class="shared-header-left">
      <text class="shared-title">ä¸ {{partnerName}} çš„å…±åŒæˆå°±ç©ºé—´</text>
      <view class="shared-score-row">
        <view class="shared-score">
          <text class="shared-score-label">å…±åŒæˆå°±å€¼</text>
          <text class="shared-score-value">{{commonScore}}</text>
        </view>
        <button class="shared-exchange-btn" bindtap="goToAchievementExchange">æˆå°±å…‘æ¢</button>
      </view>
    </view>
    <view class="shared-header-avatars">
      <block wx:if="{{!partnerAvatar || partnerAvatar === defaultAvatarUrl}}">
        <view class="shared-avatar shared-avatar-placeholder"><text class="shared-avatar-icon">ğŸ‘¤</text></view>
      </block>
      <image wx:else class="shared-avatar" src="{{partnerAvatar}}" mode="aspectFill" />
      <block wx:if="{{!meAvatar || meAvatar === defaultAvatarUrl}}">
        <view class="shared-avatar shared-avatar-placeholder shared-avatar-me"><text class="shared-avatar-icon">ğŸ‘¤</text></view>
      </block>
      <image wx:else class="shared-avatar shared-avatar-me" src="{{meAvatar}}" mode="aspectFill" />
    </view>
  </view>

  <!-- ä¸»ä½“ï¼šå·¦ä¾§æ•°æ®é¢æ¿ + å³ä¾§æˆé•¿åœ°å›¾ -->
  <view class="shared-body">
    <!-- å·¦ä¾§æ•°æ®é¢æ¿ï¼šå…±åŒè¿åŠ¨æ¬¡æ•°ã€æ—¶é•¿ã€æˆå°±å‹‹ç« å¢™ -->
    <view class="data-panel">
      <view class="data-panel-item data-panel-item-tappable" bindtap="onActivityCountTap">
        <text class="data-panel-value">{{jointExerciseCount}}</text>
        <text class="data-panel-label">å…±åŒè¿åŠ¨æ¬¡æ•°</text>
      </view>
      <view class="data-panel-item">
        <text class="data-panel-value">{{jointExerciseDuration}}</text>
        <text class="data-panel-label">å…±åŒè¿åŠ¨æ—¶é•¿</text>
      </view>
      <!-- å…±åŒè§£é”æˆå°±å‹‹ç« å¢™ï¼šå½“å‰ç”¨ emoji(icon) å±•ç¤ºï¼›åæœŸå¯æ›¿æ¢ä¸ºè‡ªç»˜/ä¸Šä¼ çš„å‹‹ç« å›¾ç‰‡
           æ›¿æ¢æ–¹å¼ï¼šåœ¨ badge-item å†…åŠ  <image wx:if="{{item.medalImage}}" src="{{item.medalImage}}" class="badge-img" />
           å¹¶æ”¹ä¸º <text wx:else class="badge-icon">{{item.icon}}</text>ï¼Œä¼˜å…ˆå±•ç¤º medalImage -->
      <view class="data-panel-badges">
        <text class="data-panel-badges-title">å…±åŒè§£é”æˆå°±</text>
        <scroll-view class="badge-wall-wrap" scroll-y enhanced>
          <view class="badge-wall">
            <view
              class="badge-item"
              wx:for="{{unlockedBadges}}"
              wx:key="id"
            >
              <text class="badge-icon">{{item.icon}}</text>
              <text class="badge-title">{{item.title}}</text>
            </view>
          </view>
        </scroll-view>
      </view>
    </view>
    <!-- å³ä¾§æˆé•¿åœ°å›¾ï¼šæ”¯æŒä¸Šä¸‹æ»‘åŠ¨æŸ¥çœ‹å†å²èŠ‚ç‚¹ -->
    <scroll-view
      class="growth-scroll"
      scroll-y="{{true}}"
      enhanced
      show-scrollbar="{{false}}"
      enable-back-to-top="{{true}}"
      bounces="{{true}}"
      bindscroll="onScroll"
    >
    <view class="growth-map">
      <!-- å±±ä½“èƒŒæ™¯å±‚ï¼ˆè¿œå±±ã€è¿‘å±±ï¼‰ -->
      <view class="mountain-wrap">
        <view class="mountain-layer mountain-far"></view>
        <view class="mountain-layer mountain-mid"></view>
        <view class="mountain-layer mountain-near"></view>
      </view>
      <!-- èŠ‚ç‚¹é—´è¿çº¿ï¼šæ¯æ®µè¿æ¥ç›¸é‚»ä¸¤èŠ‚ç‚¹ -->
      <view
        class="path-segment"
        wx:for="{{pathSegments}}"
        wx:key="index"
        style="top: {{item.top}}rpx; left: {{item.left}}rpx; height: {{item.height}}rpx; transform: rotate({{item.rotate}}deg);"
      ></view>
      <!-- å±±é¡¶ï¼šæœ€ä¸Šæ–¹ï¼Œä¹Ÿæ˜¯æˆå°±ç‚¹ï¼Œå¯ç‚¹å‡»æŸ¥çœ‹ç•™è¨€ï¼›æœªè§£é”æ—¶ä¸å…¶å®ƒæœªè§£é”èŠ‚ç‚¹æ ·å¼ä¸€è‡´ -->
      <view
        class="map-summit {{summitUnlocked ? 'unlocked' : 'locked'}} {{summitUnlocked ? 'node-tappable' : ''}}"
        data-node-id="0"
        data-node-title="é¡¶å³°"
        data-unlocked="{{summitUnlocked}}"
        catchtap="onNodeTap"
      >
        <text class="summit-icon">â›°</text>
        <text class="summit-text">é¡¶å³°</text>
      </view>
      <!-- è·¯å¾„èŠ‚ç‚¹ï¼šè‡ªä¸Šè€Œä¸‹ å·…å³°â†’é»˜å¥‘â†’æ­¥æ•°â†’æ‰“å¡â†’åˆæ¬¡ï¼ˆå±±è„šï¼‰ï¼›å¯ç‚¹å‡»æŸ¥çœ‹/å†™ç•™è¨€ -->
      <view
        class="map-node {{index % 2 === 0 ? 'map-node-left' : 'map-node-right'}} {{item.unlocked ? 'unlocked' : 'locked'}} {{item.unlocked ? 'node-tappable' : ''}}"
        wx:for="{{growthNodes}}"
        wx:key="id"
        style="top: {{item.top}}rpx;"
        data-node-id="{{item.id}}"
        data-node-title="{{item.title}}"
        data-unlocked="{{item.unlocked}}"
        catchtap="onNodeTap"
      >
        <view class="node-dot">
          <text class="node-icon">{{item.icon}}</text>
        </view>
        <view class="node-content">
          <text class="node-title">{{item.title}}</text>
          <text class="node-desc">{{item.desc}}</text>
        </view>
      </view>
      <!-- ä¸¤åŒ¹é©¬ï¼šç«™åœ¨å½“å‰/å†å²èŠ‚ç‚¹ï¼Œä¸ç«™åœ¨æœªæ¥èŠ‚ç‚¹ï¼›åæœŸå¯æ›¿æ¢ä¸ºç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ -->
      <view
        wx:if="{{hasUnlockedNodes}}"
        class="horse-wrap {{horseIsLeft ? 'horse-left' : 'horse-right'}}"
        style="top: {{horseTop}}rpx;"
      >
        <image wx:if="{{horseImage1}}" class="horse-img" src="{{horseImage1}}" mode="aspectFit" />
        <text wx:else class="horse-placeholder">ğŸ´</text>
        <image wx:if="{{horseImage2}}" class="horse-img horse-second" src="{{horseImage2}}" mode="aspectFit" />
        <text wx:else class="horse-placeholder horse-second">ğŸ´</text>
      </view>
    </view>
    </scroll-view>
  </view>

  <view class="shared-footer">
    <button class="shared-back-btn" bindtap="goBack">è¿”å›</button>
  </view>

  <!-- èŠ‚ç‚¹ç•™è¨€å¼¹çª—ï¼šæŸ¥çœ‹å†å²ç•™è¨€ + å†™æ–°ç•™è¨€ -->
  <view class="message-modal-mask" wx:if="{{showMessageModal}}" catchtap="closeMessageModal">
    <view class="message-modal" catchtap="preventTapPropagation">
      <view class="message-modal-header">
        <text class="message-modal-title">{{selectedNode.title}}</text>
        <view class="message-modal-close" bindtap="closeMessageModal">Ã—</view>
      </view>
      <scroll-view class="message-list-wrap" scroll-y scroll-into-view="{{scrollToMsgId}}" scroll-with-animation enhanced>
        <view class="message-list" wx:if="{{nodeMessages.length > 0}}">
          <view
            class="message-item {{item.isMe ? 'message-me' : 'message-partner'}}"
            wx:for="{{nodeMessages}}"
            wx:key="id"
            id="msg-{{item.id}}"
          >
            <text class="message-author">{{item.isMe ? 'æˆ‘' : partnerName}}</text>
            <text class="message-content">{{item.content}}</text>
            <text class="message-time">{{item.time}}</text>
          </view>
        </view>
        <view class="message-empty" wx:else>æš‚æ— ç•™è¨€ï¼Œå†™ä¸‹ç¬¬ä¸€æ¡å§ï½</view>
      </scroll-view>
      <view class="message-input-bar" wx:if="{{selectedNode.unlocked}}">
        <input
          class="message-input"
          placeholder="å†™ä¸€æ¡ç•™è¨€..."
          value="{{newMessageText}}"
          bindinput="onMessageInput"
          bindconfirm="submitMessage"
          confirm-type="send"
        />
        <button class="message-send-btn" bindtap="submitMessage">å‘é€</button>
      </view>
    </view>
  </view>

  <!-- å…±åŒè¿åŠ¨å†å²å¼¹çª—ï¼šæŸ¥çœ‹å„èŠ‚ç‚¹çº¦äº†ä»€ä¹ˆæ´»åŠ¨ã€æŒç»­å¤šä¹… -->
  <view class="message-modal-mask" wx:if="{{showActivityHistoryModal}}" catchtap="closeActivityHistoryModal">
    <view class="message-modal activity-history-modal" catchtap="preventTapPropagation">
      <view class="message-modal-header">
        <text class="message-modal-title">å…±åŒè¿åŠ¨å†å²</text>
        <view class="message-modal-close" bindtap="closeActivityHistoryModal">Ã—</view>
      </view>
      <scroll-view class="message-list-wrap" scroll-y enhanced>
        <view class="activity-history-list" wx:if="{{activityHistoryRecords.length > 0}}">
          <view class="activity-history-item" wx:for="{{activityHistoryRecords}}" wx:key="id">
            <view class="activity-history-main">
              <text class="activity-history-date">{{item.date}}</text>
              <text class="activity-history-activity">{{item.activity}}</text>
            </view>
            <view class="activity-history-extra">
              <text class="activity-history-duration">{{item.duration}}</text>
              <text class="activity-history-node" wx:if="{{item.nodeTitle}}">{{item.nodeTitle}}</text>
            </view>
          </view>
        </view>
        <view class="message-empty" wx:else>æš‚æ— å…±åŒè¿åŠ¨è®°å½•</view>
      </scroll-view>
    </view>
  </view>
</view>
