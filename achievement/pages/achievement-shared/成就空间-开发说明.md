# 共同成就空间 - 开发说明

## 页面结构

| 区域 | 文件 | 说明 |
|------|------|------|
| 顶部头部 | wxml | 伙伴名、共同成就值、成就兑换按钮、两人头像 |
| 左侧数据面板 | wxml + wxss | 共同运动次数、时长、成就勋章墙 |
| 右侧成长地图 | wxml + wxss + js | 山体、路径、节点、马、滚动吸附 |

---

## 成就兑换入口

共同成就值旁有「成就兑换」按钮，点击进入 `pages/achievement-exchange/achievement-exchange` 成就兑换空间，传入 `chatId` 与 `commonScore`。兑换页面为占位，后续完善兑换商品、消耗逻辑等。

---

## 左侧数据面板

### 数据项

| 字段 | 类型 | 说明 |
|------|------|------|
| `jointExerciseCount` | number | 共同运动次数，**可点击**查看历史节点：什么时候约了什么活动、持续多久 |
| `jointExerciseDuration` | string | 共同运动时长，如 "12小时" |
| `unlockedBadges` | array | 共同解锁成就，用于勋章墙 |

### 共同运动历史（点击共同运动次数）

弹窗展示历史记录：`{ date, activity, duration, nodeTitle }`。`nodeTitle` 表示对应成就节点。Mock 见 `_getMockActivityHistory`，后期接接口拉取。

### 共同解锁成就勋章墙（可替换为自绘勋章）

**当前实现**：用 `icon`（emoji）展示，数据结构 `{ id, title, icon }`。

**后期替换为自绘/上传勋章图片**：

1. **数据**：在 `growthNodes` 节点中增加 `medalImage` 字段（图片 URL 或本地路径），`unlockedBadges` 已透传该字段。
2. **WXML**（`achievement-shared.wxml` 勋章墙部分）：
   ```xml
   <image wx:if="{{item.medalImage}}" class="badge-img" src="{{item.medalImage}}" mode="aspectFit" />
   <text wx:else class="badge-icon">{{item.icon}}</text>
   ```
3. **WXSS**：为 `.badge-img` 增加样式，如 `width: 64rpx; height: 64rpx;`。

**图片来源**：用户 canvas 绘制、预设模板、后台配置等，上传后获得 URL 写入 `medalImage`。

---

## 成就节点与成长地图

### 节点数据结构（growthNodes）

| 字段 | 必填 | 说明 |
|------|------|------|
| id | ✓ | 唯一标识 |
| title | ✓ | 标题 |
| desc | ✓ | 描述 |
| icon | ✓ | emoji，默认展示用 |
| unlocked | ✓ | 是否已解锁 |
| top | ✓ | 垂直位置（rpx） |
| medalImage | ○ | 自绘勋章图片路径，有则勋章墙优先展示 |

### 相关常量（`achievement-shared.js`）

- `MAP_CONTENT_WIDTH`：成长地图内容区宽度 502rpx（750 - 左侧面板 200 - padding 48）
- `NODE_CX_LEFT` / `NODE_CX_RIGHT`：节点圆心 X（左 64，右 438）
- `NODE_CENTER_Y`：节点圆心 Y 偏移（72）
- `buildPathSegments(nodes)`：根据节点计算路径连线，线段需与节点圆心对齐；修改面板宽度时需同步调整 `MAP_CONTENT_WIDTH`

---

## 节点留言

点击**已解锁**节点可打开留言弹窗，查看历史留言并发送新留言。

### 交互

- 已解锁节点：点击打开弹窗，可查看历史 + 写留言
- 未解锁节点：点击弹出 toast「该成就尚未解锁」

### 数据结构

- 留言项：`{ id, content, isMe, time }`
- 缓存：`_nodeMessagesMap`（nodeId → 留言数组），当前为页面内存，后期改为接口拉取/提交

### 涉及文件

- `achievement-shared.wxml`：节点 `catchtap="onNodeTap"`、弹窗结构
- `achievement-shared.js`：`onNodeTap`、`_getMockMessages`、`submitMessage`
- `achievement-shared.wxss`：`.message-modal-*` 样式

### 后期接口

- 拉取：`GET /achievement/nodeMessages?chatId=&nodeId=`
- 发送：`POST /achievement/nodeMessage`，body: `{ chatId, nodeId, content }`

---

## 接口字段（loadGrowthMap）

后端返回 `data` 建议包含：

- `partnerName`：伙伴昵称
- `growthNodes`：成就节点数组
- `commonScore`：共同成就值
- `jointExerciseCount`：共同运动次数
- `jointExerciseDuration`：共同运动时长
- `horseImage1` / `horseImage2`：（可选）两人头像/马图
